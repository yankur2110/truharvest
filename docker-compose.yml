services:

  # ─────────────────────────────────────────
  # PostgreSQL database for Keycloak
  # ─────────────────────────────────────────
  keycloak-db:
    image: postgres:16
    container_name: keycloak-db
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak123
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data   # data persists on disk
    networks:
      - truharvest-network

  # ─────────────────────────────────────────
  # Keycloak — Auth server
  # Access at: http://localhost:9090
  # Admin username: admin
  # Admin password: admin
  # ─────────────────────────────────────────
  keycloak:
    image: quay.io/keycloak/keycloak:26.2.0
    container_name: keycloak
    ports:
      - "9090:8080"             # Your machine port 9090 → Keycloak's internal 8080
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak-db:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak123
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
    command: start-dev          # development mode — no HTTPS required
    depends_on:
      - keycloak-db             # start DB first, then Keycloak
    networks:
      - truharvest-network

  # ─────────────────────────────────────────
  # PostgreSQL database for Spring Boot app
  # ─────────────────────────────────────────
  app-db:
    image: postgres:16
    container_name: app-db
    ports:
      - "5532:5432"             # accessible from your Spring Boot app
    environment:
      POSTGRES_DB: truharvest
      POSTGRES_USER: truharvest
      POSTGRES_PASSWORD: truharvest123
    volumes:
      - app-db-data:/var/lib/postgresql/data        # data persists on disk
    networks:
      - truharvest-network

# ─────────────────────────────────────────
# Named volumes — data saved on your machine disk
# even if containers are stopped or removed
# ─────────────────────────────────────────
volumes:
  keycloak-db-data:
  app-db-data:

# ─────────────────────────────────────────
# Internal network — containers talk to each
# other by name (e.g. keycloak-db, app-db)
# ─────────────────────────────────────────
networks:
  truharvest-network:
    driver: bridge
